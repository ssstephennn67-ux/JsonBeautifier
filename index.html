<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Beautifier</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: ui-monospace, "Cascadia Code", "SF Mono", Monaco, monospace;
      margin: 0;
      padding: 16px;
      background: #1a1b26;
      color: #c0caf5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h1 { font-size: 1.25rem; margin: 0 0 12px 0; color: #7aa2f7; }
    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .main {
      display: flex;
      gap: 16px;
      flex: 1;
      min-height: 0;
    }
    .panel-left {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .panel-left.hidden {
      display: none;
    }
    .panel-right {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .panel-right.full-width {
      flex: 1 1 100%;
    }
    textarea {
      width: 100%;
      flex: 1;
      min-height: 200px;
      padding: 12px;
      background: #24283b;
      border: 1px solid #3b4261;
      border-radius: 8px;
      color: #c0caf5;
      font-size: 13px;
      resize: vertical;
    }
    textarea::placeholder { color: #565f89; }
    button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      background: #7aa2f7;
      color: #1a1b26;
    }
    button:hover { background: #89b4fa; }
    button.secondary { background: #3b4261; color: #c0caf5; }
    button.secondary:hover { background: #414868; }
    .error { color: #f7768e; margin-top: 8px; }
    .tree {
      flex: 1;
      padding: 12px;
      background: #24283b;
      border-radius: 8px;
      border: 1px solid #3b4261;
      overflow: auto;
    }
    .node {
      margin: 2px 0;
      font-size: 13px;
    }
    .node-head {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .node-head:hover { background: rgba(122, 162, 247, 0.15); }
    .toggle {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #565f89;
    }
    .toggle.collapsed::before { content: "▶"; }
    .toggle.expanded::before { content: "▼"; }
    .key { color: #7dcfff; }
    .key.index { color: #bb9af7; margin-right: 4px; }
    .bracket { color: #565f89; }
    .string { color: #9ece6a; }
    .number { color: #ff9e64; }
    .boolean { color: #ff9e64; }
    .null { color: #565f89; }
    .count { color: #565f89; font-size: 11px; }
    .children { margin-left: 20px; border-left: 1px solid #3b4261; padding-left: 8px; }
    .array-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 10px;
    }
    .array-actions button {
      padding: 4px 10px;
      font-size: 12px;
      line-height: 1.2;
      background: #3b4261;
      color: #c0caf5;
    }
    .array-actions button:hover { background: #414868; }
    .key-filter-wrap {
      display: inline-flex;
      align-items: center;
      position: relative;
      margin-left: 10px;
    }
    .key-filter-trigger {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid #3b4261;
      border-radius: 8px;
      background: rgba(26, 27, 38, 0.9);
      color: #a9b1d6;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
    }
    .key-filter-trigger:hover {
      background: #3b4261;
      color: #c0caf5;
    }
    .key-filter-trigger .arrow {
      font-size: 10px;
      transition: transform 0.2s;
    }
    .key-filter-wrap.expanded .key-filter-trigger .arrow {
      transform: rotate(180deg);
    }
    .key-filter-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      padding: 10px;
      background: rgba(36, 40, 59, 0.98);
      border: 1px solid #3b4261;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10;
      min-width: 140px;
    }
    .key-filter-wrap.expanded .key-filter-menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .key-filter-label {
      font-size: 11px;
      color: #565f89;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .key-filter-pills {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .key-filter-pill {
      display: block;
      width: 100%;
      padding: 6px 10px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #3b4261;
      color: #a9b1d6;
      text-align: left;
      transition: background 0.15s, color 0.15s, box-shadow 0.15s;
    }
    .key-filter-pill:hover {
      background: #414868;
      color: #c0caf5;
    }
    .key-filter-pill.active {
      background: #7aa2f7;
      color: #1a1b26;
      box-shadow: 0 0 0 1px rgba(122, 162, 247, 0.4);
    }
    .key-filter-pill.all-pill.active {
      background: #9ece6a;
      color: #1a1b26;
    }
    .key-filter-hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <h1>JSON Beautifier</h1>
  <div class="toolbar">
    <button type="button" id="parseBtn">Parse / Beautify</button>
    <button type="button" class="secondary" id="hideJsonBtn">Hide JSON</button>
    <button type="button" class="secondary" id="expandAllBtn">Expand All</button>
    <button type="button" class="secondary" id="collapseAllBtn">Collapse All</button>
    <button type="button" class="secondary" id="collapseAllChildBtn">Collapse all child</button>
  </div>
  <div class="main">
    <div class="panel-left">
      <textarea id="input" placeholder='Paste JSON here'>{"items": [{"name": "Alice", "age": 30}, {"name": "Bob", "age": 25}], "count": 2}</textarea>
      <div id="error" class="error"></div>
    </div>
    <div class="panel-right">
      <div id="output" class="tree"></div>
    </div>
  </div>

  <script>
    const inputEl = document.getElementById("input");
    const outputEl = document.getElementById("output");
    const errorEl = document.getElementById("error");
    const parseBtn = document.getElementById("parseBtn");
    const expandAllBtn = document.getElementById("expandAllBtn");
    const collapseAllBtn = document.getElementById("collapseAllBtn");
    const collapseAllChildBtn = document.getElementById("collapseAllChildBtn");
    const hideJsonBtn = document.getElementById("hideJsonBtn");
    const panelLeft = document.querySelector(".panel-left");
    const panelRight = document.querySelector(".panel-right");

    let rootNodeEl = null;
    let jsonHidden = false;

    function setError(msg) {
      errorEl.textContent = msg || "";
    }

    function escapeHtml(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function getNodeId() {
      return "n_" + Math.random().toString(36).slice(2, 11);
    }

    function isObjectOrArray(value) {
      return value !== null && typeof value === "object";
    }

    function collectExpandableIds(containerEl, expand) {
      const toggles = containerEl.querySelectorAll(".toggle.expanded, .toggle.collapsed");
      toggles.forEach((t) => {
        const head = t.closest(".node-head");
        if (!head) return;
        const node = head.closest(".node");
        if (!node) return;
        const id = node.dataset.nodeId;
        if (id) {
          const isExpanded = t.classList.contains("expanded");
          if (expand && !isExpanded) t.click();
          if (!expand && isExpanded) t.click();
        }
      });
    }

    function setExpandRecursive(nodeEl, expand) {
      const toggle = nodeEl.querySelector(".toggle");
      const children = nodeEl.querySelector(".children");
      if (!toggle || !children) return;
      const isExpanded = toggle.classList.contains("expanded");
      if (isExpanded !== expand) toggle.click();
      if (expand && children) {
        children.querySelectorAll(".node").forEach((child) => setExpandRecursive(child, true));
      }
    }

    function expandOrCollapseAllForArray(arrayNodeEl, expand) {
      const children = arrayNodeEl.querySelector(".children");
      if (!children) return;
      children.querySelectorAll(".node").forEach((child) => setExpandRecursive(child, expand));
    }

    function collectCollapsibleDescendants(nodeEl, list) {
      const childrenEl = nodeEl.querySelector(".children");
      const toggle = nodeEl.querySelector(".toggle:not(.empty)");
      if (!childrenEl || !toggle) return;
      childrenEl.querySelectorAll(":scope > .array-item-wrapper").forEach((w) => {
        const n = w.querySelector(":scope > .node");
        if (n) collectCollapsibleDescendants(n, list);
      });
      childrenEl.querySelectorAll(":scope > .node").forEach((n) => collectCollapsibleDescendants(n, list));
      list.push(nodeEl);
    }

    function collapseAllChild(rootNodeEl) {
      const list = [];
      const childrenEl = rootNodeEl.querySelector(".children");
      if (!childrenEl) return;
      childrenEl.querySelectorAll(":scope > .array-item-wrapper").forEach((w) => {
        const n = w.querySelector(":scope > .node");
        if (n) collectCollapsibleDescendants(n, list);
      });
      childrenEl.querySelectorAll(":scope > .node").forEach((n) => collectCollapsibleDescendants(n, list));
      list.reverse();
      list.forEach((node) => {
        const t = node.querySelector(".toggle");
        const c = node.querySelector(".children");
        if (t && !t.classList.contains("empty") && c) {
          t.classList.add("collapsed");
          t.classList.remove("expanded");
          c.style.display = "none";
        }
      });
    }

    function collectObjectKeysFromArray(arr) {
      const set = new Set();
      arr.forEach((item) => {
        if (item !== null && typeof item === "object" && !Array.isArray(item)) {
          Object.keys(item).forEach((k) => set.add(k));
        }
      });
      return Array.from(set).sort();
    }

    function applyArrayKeyFilter(arrayNodeEl, selectedKeys) {
      const childrenEl = arrayNodeEl.querySelector(".children");
      if (!childrenEl) return;
      
      const keySet = selectedKeys.length ? new Set(selectedKeys) : null;
      const isAll = keySet === null;
      
      // 搵出 Array 入面所有嘅直接子項 (wrapper)
      const wrappers = childrenEl.querySelectorAll(":scope > .array-item-wrapper");
      
      wrappers.forEach((wrapper) => {
        const objNode = wrapper.querySelector(":scope > .node");
        if (!objNode) return;

        // 如果係 Object，我哋要檢查佢入面邊啲 key 應該 show
        if (objNode.getAttribute("data-is-object") === "true") {
          const objChildren = objNode.querySelector(".children");
          if (!objChildren) return;

          let hasVisibleKey = false;
          
          // 遍歷 Object 嘅所有直接子項 (即係啲 Key)
          Array.from(objChildren.children).forEach((row) => {
            if (!row.classList.contains("node")) return;
            
            const rowKey = row.getAttribute("data-key");
            const shouldShowRow = isAll || keySet.has(rowKey);
            
            if (shouldShowRow) {
              row.classList.remove("key-filter-hidden");
              hasVisibleKey = true;
            } else {
              row.classList.add("key-filter-hidden");
            }
          });

          // 【關鍵點】如果呢個 Object 一個選中嘅 Key 都冇，就隱藏成個 Object Wrapper
          if (!isAll && !hasVisibleKey) {
            wrapper.classList.add("key-filter-hidden");
          } else {
            wrapper.classList.remove("key-filter-hidden");
            // 既然 Filter 緊，通常想直接見到內容，所以我自動 expand 佢
            if (!isAll) setExpandRecursive(objNode, true);
          }
        } else {
          // 如果 Array 入面唔係 Object (例如係 String/Number)，
          // 既然依家係按 Key Filter，非 Object 嘅項喺非 "All" 模式下通常應該隱藏
          if (isAll) {
            wrapper.classList.remove("key-filter-hidden");
          } else {
            wrapper.classList.add("key-filter-hidden");
          }
        }
      });
    }

    function renderValue(value, keyLabel, indexLabel) {
      const nodeId = getNodeId();
      const dataKeyAttr = keyLabel != null ? ` data-key="${escapeHtml(keyLabel)}"` : "";
      let keyPart = "";
      if (indexLabel != null) keyPart += `<span class="key index">${escapeHtml(String(indexLabel))}</span>`;
      if (keyLabel != null) keyPart += `<span class="key">${escapeHtml(String(keyLabel))}</span>`;
      if (value === null) {
        return `<div class="node" data-node-id="${nodeId}"${dataKeyAttr}><span class="node-head"><span class="toggle"></span>${keyPart}<span class="null">null</span></span></div>`;
      }
      if (typeof value === "boolean") {
        return `<div class="node" data-node-id="${nodeId}"${dataKeyAttr}><span class="node-head"><span class="toggle"></span>${keyPart}<span class="boolean">${value}</span></span></div>`;
      }
      if (typeof value === "number") {
        return `<div class="node" data-node-id="${nodeId}"${dataKeyAttr}><span class="node-head"><span class="toggle"></span>${keyPart}<span class="number">${value}</span></span></div>`;
      }
      if (typeof value === "string") {
        return `<div class="node" data-node-id="${nodeId}"${dataKeyAttr}><span class="node-head"><span class="toggle"></span>${keyPart}<span class="string">"${escapeHtml(value)}"</span></span></div>`;
      }
      if (Array.isArray(value)) {
        const len = value.length;
        const allKeys = collectObjectKeysFromArray(value);
        const keyFilterHtml = allKeys.length ? `<span class="key-filter-wrap"><button type="button" class="key-filter-trigger" title="Filter by key">Filter keys <span class="arrow">▼</span></button><span class="key-filter-menu"><span class="key-filter-label">Keys</span><span class="key-filter-pills"><button type="button" class="key-filter-pill all-pill active" data-key="" title="Show all">All</button>${allKeys.map((k) => `<button type="button" class="key-filter-pill" data-key="${escapeHtml(k)}" title="Toggle ${escapeHtml(k)}">${escapeHtml(k)}</button>`).join("")}</span></span></span>` : "";
        const childNodes = value.map((item, i) => {
          const keysAttr = (item !== null && typeof item === "object" && !Array.isArray(item)) ? ` data-object-keys="${escapeHtml(Object.keys(item).join(","))}"` : "";
          return `<div class="array-item-wrapper"${keysAttr}>${renderValue(item, null, `[${i}]`)}</div>`;
        }).join("");
        return `
          <div class="node" data-node-id="${nodeId}" data-is-array="true">
            <span class="node-head">
              <span class="toggle expanded"></span>
              ${keyPart}
              <span class="bracket">[</span>
              <span class="count">${len} items</span>
              <span class="bracket">]</span>
              <span class="array-actions">
                ${keyFilterHtml}
                <button type="button" class="expand-all-array" title="Expand all">Expand all</button>
                <button type="button" class="collapse-all-array" title="Collapse all">Collapse all</button>
              </span>
            </span>
            <div class="children">${childNodes}</div>
          </div>`;
      }
      const obj = value;
      const keys = Object.keys(obj);
      const childNodes = keys.map((k) => renderValue(obj[k], k, null)).join("");
      return `
        <div class="node" data-node-id="${nodeId}" data-is-object="true">
          <span class="node-head">
            <span class="toggle expanded"></span>
            ${keyPart}
            <span class="bracket">{</span>
            <span class="count">${keys.length} keys</span>
            <span class="bracket">}</span>
          </span>
          <div class="children">${childNodes}</div>
        </div>`;
    }

    function attachToggleListeners(containerEl) {
      containerEl.querySelectorAll(".node-head").forEach((head) => {
        const toggle = head.querySelector(".toggle");
        const node = head.closest(".node");
        const children = node.querySelector(".children");
        if (!toggle || toggle.classList.contains("empty")) return;
        toggle.addEventListener("click", (e) => {
          if (e.target.closest(".array-actions")) return;
          if (!children) return;
          const isExpanded = toggle.classList.contains("expanded");
          toggle.classList.toggle("expanded", !isExpanded);
          toggle.classList.toggle("collapsed", isExpanded);
          children.style.display = isExpanded ? "none" : "block";
        });
      });
      containerEl.querySelectorAll(".array-actions .expand-all-array").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const node = btn.closest(".node");
          if (node) expandOrCollapseAllForArray(node, true);
        });
      });
      containerEl.querySelectorAll(".array-actions .collapse-all-array").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const node = btn.closest(".node");
          if (node) expandOrCollapseAllForArray(node, false);
        });
      });
      containerEl.querySelectorAll(".key-filter-wrap").forEach((wrap) => {
        const arrayNode = wrap.closest(".node[data-is-array='true']");
        if (!arrayNode) return;
        const trigger = wrap.querySelector(".key-filter-trigger");
        const menu = wrap.querySelector(".key-filter-menu");
        trigger.addEventListener("click", (e) => {
          e.stopPropagation();
          wrap.classList.toggle("expanded");
        });
        wrap.querySelectorAll(".key-filter-pill").forEach((pill) => {
          pill.addEventListener("click", (e) => {
            e.stopPropagation();
            const key = pill.getAttribute("data-key");
            if (key === "") {
              wrap.querySelectorAll(".key-filter-pill").forEach((p) => p.classList.remove("active"));
              pill.classList.add("active");
              applyArrayKeyFilter(arrayNode, []);
              return;
            }
            pill.classList.toggle("active");
            wrap.querySelector(".all-pill").classList.remove("active");
            const selected = Array.from(wrap.querySelectorAll(".key-filter-pill.active:not(.all-pill)")).map((p) => p.getAttribute("data-key"));
            if (selected.length === 0) {
              wrap.querySelector(".all-pill").classList.add("active");
              applyArrayKeyFilter(arrayNode, []);
            } else {
              applyArrayKeyFilter(arrayNode, selected);
            }
          });
        });
      });
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".key-filter-wrap")) {
          outputEl.querySelectorAll(".key-filter-wrap.expanded").forEach((w) => w.classList.remove("expanded"));
        }
      });
    }

    function parseAndRender() {
      setError("");
      const raw = inputEl.value.trim();
      if (!raw) {
        outputEl.innerHTML = "";
        return;
      }
      let data;
      try {
        data = JSON.parse(raw);
      } catch (err) {
        setError("Invalid JSON: " + err.message);
        outputEl.innerHTML = "";
        return;
      }
      const html = renderValue(data, null, null);
      outputEl.innerHTML = html;
      rootNodeEl = outputEl.querySelector(".node");
      attachToggleListeners(outputEl);
    }

    expandAllBtn.addEventListener("click", () => {
      if (!rootNodeEl) return;
      setExpandRecursive(rootNodeEl, true);
    });
    collapseAllBtn.addEventListener("click", () => {
      if (!rootNodeEl) return;
      setExpandRecursive(rootNodeEl, false);
    });
    collapseAllChildBtn.addEventListener("click", () => {
      if (!rootNodeEl) return;
      collapseAllChild(rootNodeEl);
    });
    hideJsonBtn.addEventListener("click", () => {
      jsonHidden = !jsonHidden;
      panelLeft.classList.toggle("hidden", jsonHidden);
      panelRight.classList.toggle("full-width", jsonHidden);
      hideJsonBtn.textContent = jsonHidden ? "Show JSON" : "Hide JSON";
    });
    parseBtn.addEventListener("click", parseAndRender);
    parseAndRender();
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) parseAndRender();
    });
  </script>
</body>
</html>
